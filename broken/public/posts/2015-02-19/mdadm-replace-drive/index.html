<!DOCTYPE html>
<html lang="en">
    
    


    <head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    
    <link rel="canonical" href="https://cobus.io/posts/2015-02-19/mdadm-replace-drive/">
    
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.126.1">

    
    
    

<title>Replacing mdadm drive â€¢ (thoughts) =&gt; TryParse(thoughts, out blog)</title>



  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Replacing mdadm drive">
  <meta name="twitter:description" content="How to identify and replace a failed drive in mdadm.">

<meta property="og:url" content="https://cobus.io/posts/2015-02-19/mdadm-replace-drive/">
  <meta property="og:site_name" content="(thoughts) =&gt; TryParse(thoughts, out blog)">
  <meta property="og:title" content="Replacing mdadm drive">
  <meta property="og:description" content="How to identify and replace a failed drive in mdadm.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2015-02-19T00:00:00+00:00">
    <meta property="article:modified_time" content="2015-02-19T00:00:00+00:00">
    <meta property="article:tag" content="Linux">
    <meta property="article:tag" content="Mdadm">


    






<link rel="stylesheet" href="/scss/triple-hyde.scss" integrity="">


<link rel="stylesheet" href="/scss/print.2744dcbf8a0b2e74f8a50e4b34e5f441be7cf93cc7de27029121c6a09f9e77bc.css" integrity="sha256-J0Tcv4oLLnT4pQ5LNOX0Qb58&#43;TzH3icCkSHGoJ&#43;ed7w=" media="print">



    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="/favicon.png">
    
    

</head>


    <body class=" ">
    
<div class="sidebar">
  <div class="container ">
    <div class="sidebar-about">
  <span class="site__title">
    <a href="https://cobus.io/">
    
      (thoughts) =&gt; TryParse(thoughts, out blog)
    
    </a>
  </span>
  
  
  <p class="site__description">
    
  </p>
</div>

    <div class="collapsible-menu">
      <input type="checkbox" id="menuToggle">
      <label for="menuToggle">(thoughts) =&gt; TryParse(thoughts, out blog)</label>
      <div class="menu-content">
        <div>
	<ul class="sidebar-nav">
		 
		
	</ul>
</div>

        <section class="social">
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
</section>

      </div>
    </div>
    


  </div>
</div>

        <div class="content container">
            
    
<article>
  <header>
    <h1>Replacing mdadm drive</h1>
    
    
<div class="post__meta">
    
    
      <i class="fas fa-calendar-alt"></i> Feb 19, 2015
    
    
    
      
      
          in
          
          
              <a class="badge badge-category" href="/categories/linux">LINUX</a>
              
          
      
    
    
    
      
      
          <br/>
           <i class="fas fa-tags"></i>
          
          <a class="badge badge-tag" href="/tags/linux">linux</a>
           
      
          <a class="badge badge-tag" href="/tags/mdadm">mdadm</a>
          
      
    
    
    <br/>
    <i class="fas fa-clock"></i> 6 min read
</div>


  </header>
  
  
  <div class="post">
    <p><em>Update 2016-01-09</em>: In the previous version, I never added the command for creating the array and since then I needed it for a new server. When the array starts rebuilding, it <em>will</em> look like there is a failed drive: this is normal. When it builds from scratch, it is actually doing the rebuild process and will indicate a failed drive until the array is rebuilt.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># mdadm --create --verbose /dev/md0 --level=5 --raid-devices=3 /dev/sdb1 /dev/sdc1 /dev/sdd1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># cat /proc/mdstat</span>
</span></span><span style="display:flex;"><span>md0 : active raid5 sdd1<span style="color:#f92672">[</span>3<span style="color:#f92672">]</span> sdc1<span style="color:#f92672">[</span>1<span style="color:#f92672">]</span> sdb1<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">4294702080</span> blocks super 1.2 level 5, 512k chunk, algorithm <span style="color:#ae81ff">2</span> <span style="color:#f92672">[</span>3/2<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>UU_<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">[====</span>&gt;................<span style="color:#f92672">]</span>  recovery <span style="color:#f92672">=</span> 20.1% <span style="color:#f92672">(</span>433131624/2147351040<span style="color:#f92672">)</span> finish<span style="color:#f92672">=</span>420.1min speed<span style="color:#f92672">=</span>68006K/sec
</span></span></code></pre></div><p>As you can see from the above, this isn&rsquo;t very fast. I found <a href="http://www.cyberciti.biz/tips/linux-raid-increase-resync-rebuild-speed.html">this article</a> with some tips on increasing the speed. The one that worked for me was increasing the <code>stripe-cache_size</code> (tip 3):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># echo 32768 &gt; /sys/block/md0/md/stripe_cache_size</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>md0 : active raid5 sdd1<span style="color:#f92672">[</span>3<span style="color:#f92672">]</span> sdc1<span style="color:#f92672">[</span>1<span style="color:#f92672">]</span> sdb1<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">4294702080</span> blocks super 1.2 level 5, 512k chunk, algorithm <span style="color:#ae81ff">2</span> <span style="color:#f92672">[</span>3/2<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>UU_<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">[====</span>&gt;................<span style="color:#f92672">]</span>  recovery <span style="color:#f92672">=</span> 24.3% <span style="color:#f92672">(</span>523330980/2147351040<span style="color:#f92672">)</span> finish<span style="color:#f92672">=</span>147.1min speed<span style="color:#f92672">=</span>183976K/sec
</span></span></code></pre></div><p>Much better, about 3x faster.</p>
<h2 id="finding-the-broken-drive">Finding the broken drive</h2>
<p><strong>Original</strong>
With all the load shedding, a drive failed in my software raid array. It is a <a href="http://en.wikipedia.org/wiki/Standard_RAID_levels#RAID_5">Raid-5</a> setup, so I had time to replace the drive and rebuild the array. I was lucky with this failure as I randomly looked at my <a href="http://en.wikipedia.org/wiki/Mdadm">mdadm</a> array today - I <strong>really</strong> need to set up the mail details to allow the system to mail me when something fails. Here is the command to check the health of your arrays:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat /proc/mdstat
</span></span><span style="display:flex;"><span>Personalities : <span style="color:#f92672">[</span>raid6<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>raid5<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>raid4<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>linear<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>multipath<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>raid0<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>raid1<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>raid10<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>md0 : active raid5 sdc1<span style="color:#f92672">[</span>2<span style="color:#f92672">]</span> sda1<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span> sdb1<span style="color:#f92672">[</span>1<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">2929890816</span> blocks super 1.2 level 5, 512k chunk, algorithm <span style="color:#ae81ff">2</span> <span style="color:#f92672">[</span>4/3<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>UUU_<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>unused devices: &lt;none&gt;
</span></span></code></pre></div><h2 id="replacing-the-broken-drive">Replacing the broken drive</h2>
<p>The <code>[UUU_]</code> indicates that one of the drives is no longer part of the array. To see which drive is faulty, run <code>mdadm --detail /dev/md0</code> to get the details:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/dev/md0:
</span></span><span style="display:flex;"><span>        Version : 1.2
</span></span><span style="display:flex;"><span>  Creation Time : Mon Jun <span style="color:#ae81ff">23</span> 20:08:17 <span style="color:#ae81ff">2014</span>
</span></span><span style="display:flex;"><span>     Raid Level : raid5
</span></span><span style="display:flex;"><span>     Array Size : <span style="color:#ae81ff">2929890816</span> <span style="color:#f92672">(</span>2794.16 GiB 3000.21 GB<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  Used Dev Size : <span style="color:#ae81ff">976630272</span> <span style="color:#f92672">(</span>931.39 GiB 1000.07 GB<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>   Raid Devices : <span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span>  Total Devices : <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>    Persistence : Superblock is persistent
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Update Time : Fri Feb <span style="color:#ae81ff">17</span> 08:24:12 <span style="color:#ae81ff">2015</span>
</span></span><span style="display:flex;"><span>          State : clean, degraded
</span></span><span style="display:flex;"><span> Active Devices : <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>Working Devices : <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span> Failed Devices : <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  Spare Devices : <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>         Layout : left-symmetric
</span></span><span style="display:flex;"><span>     Chunk Size : 512K
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>           Name : Token:0  <span style="color:#f92672">(</span>local to host Token<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>           UUID : 0b9ec9a1:73b38783:7bccad64:04b10ed8
</span></span><span style="display:flex;"><span>         Events : <span style="color:#ae81ff">758663</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Number   Major   Minor   RaidDevice State
</span></span><span style="display:flex;"><span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">8</span>        <span style="color:#ae81ff">1</span>        <span style="color:#ae81ff">0</span>      active sync   /dev/sda1
</span></span><span style="display:flex;"><span>       <span style="color:#ae81ff">1</span>       <span style="color:#ae81ff">8</span>       <span style="color:#ae81ff">17</span>        <span style="color:#ae81ff">1</span>      active sync   /dev/sdb1
</span></span><span style="display:flex;"><span>       <span style="color:#ae81ff">2</span>       <span style="color:#ae81ff">8</span>       <span style="color:#ae81ff">33</span>        <span style="color:#ae81ff">2</span>      active sync   /dev/sdc1
</span></span><span style="display:flex;"><span>       <span style="color:#ae81ff">4</span>       <span style="color:#ae81ff">0</span>        <span style="color:#ae81ff">0</span>        <span style="color:#ae81ff">3</span>      removed
</span></span></code></pre></div><p>This indicated that the last drive <code>/dev/sdd1</code> was missing. To figure out which drive this is, you can grab the serial number using <a href="http://www.smartmontools.org/">SmartMontools</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo apt-get install smartmontools
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>smartctl -a /dev/sdd | grep Serial
</span></span><span style="display:flex;"><span>Serial Number:    3NX12345
</span></span></code></pre></div><p>Time to open up the server and find the faulty drive. My server has hot swap bays and I guessed &lsquo;sdd&rsquo; to be the fourth drive, so got the right one on my first attempt. Replaced the drive with a spare I had - originally I ran a 8x 1TB Raid-5 array on a different server, but the power usage was too high, so scaled things down a bit. To get the backup drive correctly partitioned, I deleted all the existing partitions and added a new one with file-system type &lsquo;fd&rsquo; for &lsquo;Linux Raid autodetect&rsquo; using <code>fdisk</code>. To add the disk back into the array, use <code>mdadm --manage /dev/md0 --add /dev/sdd1</code>. To check the progress, look at <code>/proc/mdstat</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat /proc/mdstat
</span></span><span style="display:flex;"><span>Personalities : <span style="color:#f92672">[</span>raid6<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>raid5<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>raid4<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>linear<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>multipath<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>raid0<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>raid1<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>raid10<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>md0 : active raid5 sdd1<span style="color:#f92672">[</span>4<span style="color:#f92672">]</span> sdc1<span style="color:#f92672">[</span>2<span style="color:#f92672">]</span> sda1<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span> sdb1<span style="color:#f92672">[</span>1<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">2929890816</span> blocks super 1.2 level 5, 512k chunk, algorithm <span style="color:#ae81ff">2</span> <span style="color:#f92672">[</span>4/3<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>UUU_<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">[</span>&gt;....................<span style="color:#f92672">]</span>  recovery <span style="color:#f92672">=</span>  0.0% <span style="color:#f92672">(</span>190080/976630272<span style="color:#f92672">)</span> finish<span style="color:#f92672">=</span>256.8min speed<span style="color:#f92672">=</span>63360K/sec
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>unused devices: &lt;none&gt;
</span></span></code></pre></div><p>All good, now just need to wait till the rebuild is complete. It is advisable to stop all processes / applications during this period to speed up the rebuild. In my case, stopping <a href="http://kodi.tv/">XMBC</a> increased the speed by 10x. Once the rebuild is complete, you should see something like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat /proc/mdstat
</span></span><span style="display:flex;"><span>Personalities : <span style="color:#f92672">[</span>raid6<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>raid5<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>raid4<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>linear<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>multipath<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>raid0<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>raid1<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>raid10<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>md0 : active raid5 sdd1<span style="color:#f92672">[</span>4<span style="color:#f92672">]</span> sdc1<span style="color:#f92672">[</span>2<span style="color:#f92672">]</span> sda1<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span> sdb1<span style="color:#f92672">[</span>1<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">2929890816</span> blocks super 1.2 level 5, 512k chunk, algorithm <span style="color:#ae81ff">2</span> <span style="color:#f92672">[</span>4/4<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>UUUU<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>unused devices: &lt;none&gt;
</span></span></code></pre></div><h2 id="notifications-for-future-failures">Notifications for future failures</h2>
<p>Now to ensure we get notified about any future fails, we need to set up mailing. I found <a href="http://ubuntuforums.org/showthread.php?t=1185134">this post</a> which looked to be what I needed. Here is the short version:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo apt-get install msmtp msmtp-mta
</span></span></code></pre></div><p>To find the global configuration file, use <code>msmtp --version | grep &quot;System configuration&quot;</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>System configuration file name: /etc/msmtprc
</span></span></code></pre></div><p>Edit the file with <code>sudo vi /etc/msmtprc</code> and add (remember to replace with your specific details and also to enable SMTP on your GMail account):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># ------------------------------------------------------------------------------</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># msmtp System Wide Configuration file</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ------------------------------------------------------------------------------</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># A system wide configuration is optional.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># If it exists, it usually defines a default account.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># This allows msmtp to be used like /usr/sbin/sendmail.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ------------------------------------------------------------------------------</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Accounts</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ------------------------------------------------------------------------------</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># gmail account</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Configuring for gmail is beyond the scope of this tutorial</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Googling for &#34;gmail msmtp&#34; should help</span>
</span></span><span style="display:flex;"><span>account gmail
</span></span><span style="display:flex;"><span>host smtp.gmail.com
</span></span><span style="display:flex;"><span>port <span style="color:#ae81ff">587</span>
</span></span><span style="display:flex;"><span>from youremail@gmail.com
</span></span><span style="display:flex;"><span>tls on
</span></span><span style="display:flex;"><span>tls_starttls on
</span></span><span style="display:flex;"><span>tls_trust_file /etc/ssl/certs/ca-certificates.crt
</span></span><span style="display:flex;"><span>auth on
</span></span><span style="display:flex;"><span>user youremail
</span></span><span style="display:flex;"><span>password supersecret
</span></span><span style="display:flex;"><span>syslog LOG_MAIL
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Other ISP Account</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Configuring for other ISPs is beyond the scope of this tutorial</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Googling for &#34;myisp outlook smtp&#34; should help</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ------------------------------------------------------------------------------</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Configurations</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ------------------------------------------------------------------------------</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Construct envelope-from addresses of the form &#34;user@oursite.example&#34;.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#auto_from on</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#maildomain fermmy.server</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Use TLS.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#tls on</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#tls_trust_file /etc/ssl/certs/ca-certificates.crt</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Syslog logging with facility LOG_MAIL instead of the default LOG_USER.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Must be done within &#34;account&#34; sub-section above</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#syslog LOG_MAIL</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Set a default account</span>
</span></span><span style="display:flex;"><span>account default : gmail
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ------------------------------------------------------------------------------</span>
</span></span></code></pre></div><p>To test, run <code>echo &quot;This is a test e-mail from my server using msmtp&quot; | msmtp -d youremail@gmail.com</code>. It should print out multiple lines, any error will be clearly displayed as such, i.e.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>--&gt; AUTH PLAIN AGNvYnVzYXyXbmFyZGuYYmthdnFiam9seXZlaGJiZA<span style="color:#f92672">==</span>
</span></span><span style="display:flex;"><span>&lt;-- 535-5.7.8 Username and Password not accepted. Learn more at
</span></span><span style="display:flex;"><span>&lt;-- <span style="color:#ae81ff">535</span> 5.7.8 http://support.google.com/mail/bin/answer.py?answer<span style="color:#f92672">=</span><span style="color:#ae81ff">14257</span> n1sm2519061wib.11 - gsmtp
</span></span><span style="display:flex;"><span>msmtp: authentication failed <span style="color:#f92672">(</span>method PLAIN<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>msmtp: server message: 535-5.7.8 Username and Password not accepted. Learn more at
</span></span><span style="display:flex;"><span>msmtp: server message: <span style="color:#ae81ff">535</span> 5.7.8 http://support.google.com/mail/bin/answer.py?answer<span style="color:#f92672">=</span><span style="color:#ae81ff">14257</span> n1sm2519061wib.11 - gsmtp
</span></span><span style="display:flex;"><span>msmtp: could not send mail <span style="color:#f92672">(</span>account default from /etc/msmtprc<span style="color:#f92672">)</span>
</span></span></code></pre></div><p>Now to replace the <code>sendmail</code> command with <code>msmtp</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo mv /usr/sbin/sendmail /usr/sbin/sendmail.bak
</span></span><span style="display:flex;"><span>sudo ln -s /usr/bin/msmtp /usr/sbin/sendmail
</span></span></code></pre></div><p>Add these lines to you <code>/etc/mdadm/mdadm.conf</code> file:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># instruct the monitoring daemon where to send mail alerts</span>
</span></span><span style="display:flex;"><span>MAILADDR youremail@domain.com
</span></span><span style="display:flex;"><span>MAILFROM my-server-name - mdadm
</span></span></code></pre></div><p>Then to test, use <code>sudo mdadm --monitor --scan --test --oneshot</code>. If all is set up correctly, you should get a mail like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>This is an automatically generated mail message from mdadm
</span></span><span style="display:flex;"><span>running on Token
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>A SparesMissing event had been detected on md device /dev/md0.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Faithfully yours, etc.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>P.S. The /proc/mdstat file currently contains the following:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Personalities : <span style="color:#f92672">[</span>raid6<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>raid5<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>raid4<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>linear<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>multipath<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>raid0<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>raid1<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>raid10<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>md0 : active raid5 sdc1<span style="color:#f92672">[</span>2<span style="color:#f92672">]</span> sdb1<span style="color:#f92672">[</span>1<span style="color:#f92672">]</span> sda1<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span> sdd1<span style="color:#f92672">[</span>4<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">2929890816</span> blocks super 1.2 level 5, 512k chunk, algorithm <span style="color:#ae81ff">2</span> <span style="color:#f92672">[</span>4/4<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>UUUU<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>unused devices: &lt;none&gt;
</span></span></code></pre></div><p>So after all that, you should be notified when something goes wrong and be able to correct it before loosing all your data.</p>

  </div>
  

<div class="navigation navigation-single">
    
    <a href="/posts/2015-02-17/route-53-dns-update-script/" class="navigation-prev">
      <i aria-hidden="true" class="fa fa-chevron-left"></i>
      <span class="navigation-tittle">Moving DNS to Amazon Route 53, Dynamic Updates</span>
    </a>
    
    
    <a href="/posts/2015-02-27/git-checkout-ssh-vs-https/" class="navigation-next">
      <span class="navigation-tittle">Git checkout error for public repo</span>
      <i aria-hidden="true" class="fa fa-chevron-right"></i>
    </a>
    
</div>


  

  
    


</article>


        </div>
        
    




    



    </body>
</html>
