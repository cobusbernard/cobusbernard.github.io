<!DOCTYPE html>
<html lang="en">
    
    


    <head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    
    <link rel="canonical" href="https://cobus.io/posts/2016-02-06/parameterizing-webconfig/">
    
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.126.1">

    
    
    

<title>Parameterizing Web.config â€¢ (thoughts) =&gt; TryParse(thoughts, out blog)</title>



  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Parameterizing Web.config">
  <meta name="twitter:description" content="How to change the values of web.config at deploy time without configuration profiles.">

<meta property="og:url" content="https://cobus.io/posts/2016-02-06/parameterizing-webconfig/">
  <meta property="og:site_name" content="(thoughts) =&gt; TryParse(thoughts, out blog)">
  <meta property="og:title" content="Parameterizing Web.config">
  <meta property="og:description" content="How to change the values of web.config at deploy time without configuration profiles.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2016-02-06T00:00:00+00:00">
    <meta property="article:modified_time" content="2016-02-06T00:00:00+00:00">
    <meta property="article:tag" content="Windows">
    <meta property="article:tag" content="Webapi">
    <meta property="article:tag" content="Builds">


    






<link rel="stylesheet" href="/scss/triple-hyde.scss" integrity="">


<link rel="stylesheet" href="/scss/print.2744dcbf8a0b2e74f8a50e4b34e5f441be7cf93cc7de27029121c6a09f9e77bc.css" integrity="sha256-J0Tcv4oLLnT4pQ5LNOX0Qb58&#43;TzH3icCkSHGoJ&#43;ed7w=" media="print">



    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="/favicon.png">
    
    

</head>


    <body class=" ">
    
<div class="sidebar">
  <div class="container ">
    <div class="sidebar-about">
  <span class="site__title">
    <a href="https://cobus.io/">
    
      (thoughts) =&gt; TryParse(thoughts, out blog)
    
    </a>
  </span>
  
  
  <p class="site__description">
    
  </p>
</div>

    <div class="collapsible-menu">
      <input type="checkbox" id="menuToggle">
      <label for="menuToggle">(thoughts) =&gt; TryParse(thoughts, out blog)</label>
      <div class="menu-content">
        <div>
	<ul class="sidebar-nav">
		 
		
	</ul>
</div>

        <section class="social">
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
</section>

      </div>
    </div>
    


  </div>
</div>

        <div class="content container">
            
    
<article>
  <header>
    <h1>Parameterizing Web.config</h1>
    
    
<div class="post__meta">
    
    
      <i class="fas fa-calendar-alt"></i> Feb 06, 2016
    
    
    
      
      
          in
          
          
              <a class="badge badge-category" href="/categories/devops">DEVOPS</a>
              
          
      
    
    
    
      
      
          <br/>
           <i class="fas fa-tags"></i>
          
          <a class="badge badge-tag" href="/tags/windows">windows</a>
           
      
          <a class="badge badge-tag" href="/tags/webapi">webapi</a>
           
      
          <a class="badge badge-tag" href="/tags/builds">builds</a>
          
      
    
    
    <br/>
    <i class="fas fa-clock"></i> 6 min read
</div>


  </header>
  
  
  <div class="post">
    <p>Most people would have experienced the issue of setting values in <code>web.config</code> for a project on different environments, i.e. the connection string for the database. My first attempt at resolving this was to simply create multiple configurations and build the appropriate one per environment. This has multiple issues: you are including sensitive information in your build artifact, creating different builds for the same version (to allow different values) and tightly coupling your build process to your environment values. This will require a rebuild if your connection string changes, which could be problematic if you are unable to build a specific version easily. But it won&rsquo;t be the exact same version as you would need to commit the new config value, re-tag and finally rebuild the solution. Sounds like too much effort for a simple change.</p>
<h2 id="creating-a-project-to-test-this">Creating a project to test this</h2>
<p>First, let&rsquo;s create a new solution to work with. Create project -&gt; Web -&gt; ASP.Net Web Application</p>
<p><img alt="Create Project" src="./images/web_api_create_project.png"></p>
<p><img alt="Create Project Options" src="./images/web_api_create_project_options.png"></p>
<p><img alt="Create Project Authentication" src="./images/web_api_create_project_authentication.png"></p>
<p>Save the project and close it. Your folder should look like this:</p>
<p><img alt="Default Project Structure" src="./images/web_api_default_structure.png"></p>
<p>You often have additional files to store in your version control system, so I prefer to keep all my source in a sub-folder called <code>src</code>. Move the files into the directory and you should have a folder structure like this:</p>
<p><img alt="Suggested Project Structure" src="./images/web_api_new_structure.png"></p>
<h2 id="adding-the-parametersxml-file">Adding the parameters.xml file</h2>
<p>There is feature that isn&rsquo;t very well known: you can set parameters in the <code>web.config</code> at deployment time via a <code>SetParameters.xml</code> file if you are creating your build artifact via <a href="https://msdn.microsoft.com/en-us/library/wea2sca5(v=vs.90).aspx">MSBuild</a>. If you want to add additional parameters into it, add <code>parameters.xml</code> to the project you are publishing.</p>
<p><img alt="Adding parameters.xml" src="./images/web_api_add_parameters.png"></p>
<p>Now add the following content to it:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;parameters&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;parameter</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;IIS Web Application Name&#34;</span> <span style="color:#a6e22e">defaultValue=</span><span style="color:#e6db74">&#34;Default Web Site/WebApi.Template&#34;</span><span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;parameter</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;NHibernate Connection string&#34;</span> <span style="color:#a6e22e">defaultValue=</span><span style="color:#e6db74">&#34;&#34;</span> <span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;parameterEntry</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">kind=</span><span style="color:#e6db74">&#34;XmlFile&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">scope=</span><span style="color:#e6db74">&#34;Website\\Web\.config$&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">match=</span><span style="color:#e6db74">&#34;/configuration/connectionStrings/add[@name=&#39;NHibernateConnection&#39;]/@connectionString&#34;</span> <span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;/parameter&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;parameter</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;LOGENTRIES_TOKEN&#34;</span> <span style="color:#a6e22e">defaultValue=</span><span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;parameterEntry</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">kind=</span><span style="color:#e6db74">&#34;XmlFile&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">scope=</span><span style="color:#e6db74">&#34;Website\\Web\.config$&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">match=</span><span style="color:#e6db74">&#34;/configuration/appSettings/add[@key=&#39;LOGENTRIES_TOKEN&#39;]/@value&#34;</span> <span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;/parameter&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/parameters&gt;</span>
</span></span></code></pre></div><p>The important parts to note here are:</p>
<ul>
<li><code>name=&quot;&lt;parameter name&gt;&quot;</code> - Allows giving the parameter a human readable name, i.e. <code>NHibnernation Connection string</code></li>
<li><code>defaultValue=&quot;&quot;</code> - you can specify a default value to use if there is none in the <code>SetParameters.xml</code> file for it, i.e. <code>INFO</code> as the log level if not specified. Leaving it empty will enforce adding a value to the <code>SetParameters.xml</code> file.</li>
<li><code>scope=&quot;Website\\Web\.config$&quot;</code> - Specifies the file to search using the <code>match</code> string. The default packaging does not put the files in this folder structure, more on that further down.</li>
<li><code>match=&quot;/configuration/connectionStrings/add[@name='NHibernateConnection']/@connectionString&quot; /&gt;</code> - The location of the value to set using the value we provide. Once again, more on this further down.</li>
</ul>
<h2 id="creating-a-publishing-profile">Creating a publishing profile</h2>
<p>This will allow you to add additional parameters to <code>SetParameters.xml</code>. To test what this does, we can use the publish feather in Visual Studio to publish to a local file. Create a publishing profile by right-clicking on the <code>WebApi.Template</code> project and selecting <code>Publish</code> and click on <code>Custom</code>. Use the following values which are relative to your project file. This is where the folder structure starts to help, we will be creating a <code>dist</code> folder next to the <code>src</code> one to which we will publish the project. Once we add the solution to source control, we can exclude the <code>dist</code> folder to avoid committing compiled code.</p>
<p><img alt="Publish Profile Create" src="./images/web_api_create_local_publish_profile.png"></p>
<p><img alt="Publish Profile Connection" src="./images/web_api_publish_profile_location.png"></p>
<p><img alt="Publish Profile Settings" src="./images/web_api_publish_profile_settings.png"></p>
<p><img alt="Publish Profile Preview" src="./images/web_api_publish_profile_preview.png"></p>
<p>After clicking finish, you will should see the following in the build output at the bottom of Visual Studio:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#ae81ff">1</span>&gt;------ Build started<span style="color:#960050;background-color:#1e0010">:</span> Project<span style="color:#960050;background-color:#1e0010">:</span> WebApi.Template, Configuration<span style="color:#960050;background-color:#1e0010">:</span> Release Any CPU ------
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span>&gt;  WebApi.Template -&gt; V:\Personal\WebApi.Template\src\WebApi.Template\bin\WebApi.Template.dll
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span>&gt;------ Publish started<span style="color:#960050;background-color:#1e0010">:</span> Project<span style="color:#960050;background-color:#1e0010">:</span> WebApi.Template, Configuration<span style="color:#960050;background-color:#1e0010">:</span> Release Any CPU ------
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span>&gt;Transformed Web.config using V:\Personal\WebApi.Template\src\WebApi.Template\Web.Release.config into obj\Release\TransformWebConfig\transformed\Web.config.
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span>&gt;Auto ConnectionString Transformed Areas\HelpPage\Views\Web.config into obj\Release\CSAutoParameterize\transformed\Areas\HelpPage\Views\Web.config.
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span>&gt;Auto ConnectionString Transformed Views\Web.config into obj\Release\CSAutoParameterize\transformed\Views\Web.config.
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span>&gt;Auto ConnectionString Transformed obj\Release\TransformWebConfig\transformed\Web.config into obj\Release\CSAutoParameterize\transformed\Web.config.
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span>&gt;Copying all files to temporary location below <span style="color:#66d9ef">for</span> package/publish<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span>&gt;obj\Release\Package\PackageTmp.
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span>&gt;Packaging into V:\Personal\WebApi.Template\src\dist\WebApi.Template.zip.
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span>&gt;Adding sitemanifest (sitemanifest).
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span>&gt;Adding IIS Application (V:\Personal\WebApi.Template\src\WebApi.Template\obj\Release\Package\PackageTmp)
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span>&gt;Creating application (V:\Personal\WebApi.Template\src\WebApi.Template\obj\Release\Package\PackageTmp)
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span>&gt;Adding virtual path (V:\Personal\WebApi.Template\src\WebApi.Template\obj\Release\Package\PackageTmp)
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span>&gt;Adding directory (V:\Personal\WebApi.Template\src\WebApi.Template\obj\Release\Package\PackageTmp).
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span>&gt;Adding file (V:\Personal\WebApi.Template\src\WebApi.Template\obj\Release\Package\PackageTmp\Web.config).
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span>&gt;Adding ACL<span style="color:#e6db74">&#39;s for path (V:\Personal\WebApi.Template\src\WebApi.Template\obj\Release\Package\PackageTmp)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">2&gt;Adding ACL&#39;</span>s <span style="color:#66d9ef">for</span> path (V:\Personal\WebApi.Template\src\WebApi.Template\obj\Release\Package\PackageTmp)
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span>&gt;Adding declared parameter <span style="color:#e6db74">&#39;IIS Web Application Name&#39;</span>.
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span>&gt;Adding declared parameter <span style="color:#e6db74">&#39;NHibernate Connection string&#39;</span>.
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span>&gt;Adding declared parameter <span style="color:#e6db74">&#39;LOGENTRIES_TOKEN&#39;</span>.
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span>&gt;Package <span style="color:#e6db74">&#34;WebApi.Template.zip&#34;</span> is successfully created as single file at the following location<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span>&gt;file<span style="color:#960050;background-color:#1e0010">:</span>///V:/Personal/WebApi.Template/src/dist
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span>&gt;To get the instructions on how to deploy the web package please visit the following link<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span>&gt;http<span style="color:#960050;background-color:#1e0010">:</span>//go.microsoft.com/fwlink/<span style="color:#66d9ef">?</span>LinkId=<span style="color:#ae81ff">124618</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span>&gt;Sample script <span style="color:#66d9ef">for</span> deploying this package is generated at the following location<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span>&gt;V:\Personal\WebApi.Template\src\dist\WebApi.Template.deploy.cmd
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span>&gt;<span style="color:#66d9ef">For</span> this sample script, you can change the deploy parameters by changing the following file<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span>&gt;V:\Personal\WebApi.Template\src\dist\WebApi.Template.SetParameters.xml
</span></span><span style="display:flex;"><span>========== Build<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#ae81ff">1</span> succeeded, <span style="color:#ae81ff">0</span> failed, <span style="color:#ae81ff">0</span> up-to-date, <span style="color:#ae81ff">0</span> skipped ==========
</span></span><span style="display:flex;"><span>========== Publish<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#ae81ff">1</span> succeeded, <span style="color:#ae81ff">0</span> failed, <span style="color:#ae81ff">0</span> skipped ==========
</span></span></code></pre></div><p>You will see the following lines in the output pertaining to our new parameters file:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#ae81ff">2</span>&gt;Adding declared parameter <span style="color:#e6db74">&#39;IIS Web Application Name&#39;</span>.
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span>&gt;Adding declared parameter <span style="color:#e6db74">&#39;NHibernate Connection string&#39;</span>.
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span>&gt;Adding declared parameter <span style="color:#e6db74">&#39;LOGENTRIES_TOKEN&#39;</span>.
</span></span></code></pre></div><p>When you open up the zip, you will see the following:</p>
<p><img alt="Published project" src="./images/web_api_artifacts.png"></p>
<p>Inside the <code>SetParameters.xml</code> you will see the following values:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#75715e">&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;parameters&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;setParameter</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;IIS Web Application Name&#34;</span> <span style="color:#a6e22e">value=</span><span style="color:#e6db74">&#34;Default Web Site/WebApi.Template&#34;</span> <span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;setParameter</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;NHibernate Connection string&#34;</span> <span style="color:#a6e22e">value=</span><span style="color:#e6db74">&#34;&#34;</span> <span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;setParameter</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;LOGENTRIES_TOKEN&#34;</span> <span style="color:#a6e22e">value=</span><span style="color:#e6db74">&#34;&#34;</span> <span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/parameters&gt;</span>
</span></span></code></pre></div><h2 id="changing-the-publish-folder-structure">Changing the publish folder structure</h2>
<p>By default, the location inside the zip file is fairly insane, here is what it would be for the project created above:
<code>WebApi.Template.zip\Content\V_C\Personal\WebApi.Template\src\WebApi.Template\obj\Release\Package\PackageTmp</code> for the project that is stored in <code>V:\Personal\WebApi.Template\src</code>. To address this, add the following to the end of your project file (I&rsquo;ve included the default commented out before/after build targets help find the position):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>  <span style="color:#75715e">&lt;!-- To modify your build process, add your task inside one of the targets below and uncomment it.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">       Other similar extension points exist, see Microsoft.Common.targets.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  &lt;Target Name=&#34;BeforeBuild&#34;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  &lt;/Target&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  &lt;Target Name=&#34;AfterBuild&#34;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  &lt;/Target&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  --&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;PropertyGroup&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;PackagePath</span> <span style="color:#a6e22e">Condition=</span><span style="color:#e6db74">&#34; &#39;$(PackagePath)&#39;==&#39;&#39; &#34;</span><span style="color:#f92672">&gt;</span>Website<span style="color:#f92672">&lt;/PackagePath&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;EnableAddReplaceToUpdatePackagePath</span> <span style="color:#a6e22e">Condition=</span><span style="color:#e6db74">&#34; &#39;$(EnableAddReplaceToUpdatePackagePath)&#39;==&#39;&#39; &#34;</span><span style="color:#f92672">&gt;</span>true<span style="color:#f92672">&lt;/EnableAddReplaceToUpdatePackagePath&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;PackageDependsOn&gt;</span>
</span></span><span style="display:flex;"><span>    $(PackageDependsOn);
</span></span><span style="display:flex;"><span>    AddReplaceRuleForAppPath;
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;/PackageDependsOn&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;/PropertyGroup&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;Target</span> <span style="color:#a6e22e">Name=</span><span style="color:#e6db74">&#34;AddReplaceRuleForAppPath&#34;</span> <span style="color:#a6e22e">Condition=</span><span style="color:#e6db74">&#34; &#39;$(EnableAddReplaceToUpdatePackagePath)&#39;==&#39;true&#39; &#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;PropertyGroup&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;_PkgPathFull&gt;</span>$([System.IO.Path]::GetFullPath($(WPPAllFilesInSingleFolder)))<span style="color:#f92672">&lt;/_PkgPathFull&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/PropertyGroup&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">&lt;!-- escape the text into a regex --&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;EscapeTextForRegularExpressions</span> <span style="color:#a6e22e">Text=</span><span style="color:#e6db74">&#34;$(_PkgPathFull)&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;Output</span> <span style="color:#a6e22e">TaskParameter=</span><span style="color:#e6db74">&#34;Result&#34;</span> <span style="color:#a6e22e">PropertyName=</span><span style="color:#e6db74">&#34;_PkgPathRegex&#34;</span> <span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/EscapeTextForRegularExpressions&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">&lt;!-- add the replace rule to update the path --&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;ItemGroup&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;MsDeployReplaceRules</span> <span style="color:#a6e22e">Include=</span><span style="color:#e6db74">&#34;replaceFullPath&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;Match&gt;</span>$(_PkgPathRegex)<span style="color:#f92672">&lt;/Match&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;Replace&gt;</span>$(PackagePath)<span style="color:#f92672">&lt;/Replace&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;/MsDeployReplaceRules&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/ItemGroup&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;/Target&gt;</span>
</span></span></code></pre></div><p>Now when we publish, the directory structure inside the archive will be: <code>WebApi.Template.zip\Content\Website</code>. This ties in the value specified in <code>parameters.xml</code> for the <code>scope</code> element.</p>
<h2 id="xml-matching-in-webconfig">XML Matching in Web.config</h2>
<p>Earlier in this post, there was an element in the <code>parameters.xml</code> file called <code>match</code> with the following 2 values:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>match<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/configuration/connectionStrings/add[@name=&#39;NHibernateConnection&#39;]/@connectionString&#34;</span> /&gt;
</span></span><span style="display:flex;"><span>match<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/configuration/appSettings/add[@key=&#39;LOGENTRIES_TOKEN&#39;]/@value&#34;</span> /&gt;
</span></span></code></pre></div><p>This is used to lookup values in the <code>web.config</code> with a structure like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;configuration&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;connectionStrings&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;add</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;NHibernateConnection&#34;</span> <span style="color:#a6e22e">connectionString=</span><span style="color:#e6db74">&#34;Data Source=localhost;Initial Catalog=WebApiTemplate;Integrated Security=True&#34;</span> <span style="color:#a6e22e">providerName=</span><span style="color:#e6db74">&#34;System.Data.SqlClient&#34;</span> <span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;/connectionStrings&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;appSettings&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;add</span> <span style="color:#a6e22e">key=</span><span style="color:#e6db74">&#34;LOGENTRIES_TOKEN&#34;</span> <span style="color:#a6e22e">value=</span><span style="color:#e6db74">&#34;123456&#34;</span> <span style="color:#f92672">/&gt;</span>    
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;add</span> <span style="color:#a6e22e">key=</span><span style="color:#e6db74">&#34;SomeRandomValue&#34;</span> <span style="color:#a6e22e">value=</span><span style="color:#e6db74">&#34;123456&#34;</span> <span style="color:#f92672">/&gt;</span>    
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;/appSettings&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;customValues&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;value</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;MyField&#34;</span><span style="color:#f92672">&gt;</span>value<span style="color:#f92672">&lt;/value&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;/customValues&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/configuration&gt;</span>
</span></span></code></pre></div><p>You can see that the nesting of the xml matches the string in the <code>match</code> element. If you need to choose between multiple elements on a specific node, the <code>&lt;element name&gt;[@&lt;identifying field&gt;='string to match']</code> will allow you to do so. I.e. for the <code>LOGENTRIES_TOKEN</code> node, unless you specify this, you will not be able to distinguish between it and <code>SomeRandomValue</code>. To set a value between the xml tags, i.e. <code>&lt;myField&gt;value&lt;/myField&gt;</code>, you would use the matching string of <code>match=&quot;/configuration/customValues/value[@name='MyField']/text()&quot;</code>.</p>
<p>In later posts, I will be showing how to incorporate this into your <a href="https://github.com/psake/psake">PSake</a> build script, here is what it will resemble:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>msbuild /t:Package /v:q /p:VisualStudioVersion=<span style="color:#ae81ff">12.0</span> /p:Configuration=Release /p:PackageLocation=..\dist\WebApi.Template.zip /p:ProjectParametersXMLFile=src\WebApi.Template\parameters.xml /p:DeployIisAppPath=dist src\WebApi.Template\WebApi.Template.csproj
</span></span></code></pre></div><h2 id="lastly">Lastly</h2>
<p>We now have the ability to build and package our project without including any configuration required to run it. When it is time to deploy the api, you can set values in the <code>SetParameters.xml</code> file according to your environment and use <a href="http://www.iis.net/downloads/microsoft/web-deploy">MSDeploy</a> to deploy. At the moment, you might be thinking <em>that is a lot of effort for something that still requires manual intervention</em>. Stay tuned, in the next post, I will show you how to create a build script using PSake that will build on top of this and the following post how we start automating deployments using this mechanism.</p>
<!--
2024/05/29: Discovered the code was never uploaded, leaving this here in case I ever find the old code somewhere.

The source used in the post has been uploaded to [GitHub](https://github.com/cobusbernard/CSharp.WebApi.Template) with commits as part of each step.

- [Moving the solution into the src directory](https://github.com/cobusbernard/CSharp.WebApi.Template/commit/8a2bffbe05558053a2f2070f216ab8817262faa5)
- [Adding the parameters.xml file](https://github.com/cobusbernard/CSharp.WebApi.Template/commit/170322e2320a355590ec6c19a01b4646b2c7ff76)
- [Adding the local publishing profile](https://github.com/cobusbernard/CSharp.WebApi.Template/commit/5430cae9e205db2d49db83cbbcdcbba9797d03b6)
- [Updating the project file to publish to a more sane directory](https://github.com/cobusbernard/CSharp.WebApi.Template/commit/3ed4384939f45bda82065df202030e1765a0412d)
-->
  </div>
  

<div class="navigation navigation-single">
    
    <a href="/posts/2015-12-16/ntp-on-aws/" class="navigation-prev">
      <i aria-hidden="true" class="fa fa-chevron-left"></i>
      <span class="navigation-tittle">NTP on AWS</span>
    </a>
    
    
    <a href="/posts/2016-02-18/upgrading-berks-dependency-issue/" class="navigation-next">
      <span class="navigation-tittle">Upgrading a Chef cookbook with Berkshelf</span>
      <i aria-hidden="true" class="fa fa-chevron-right"></i>
    </a>
    
</div>


  

  
    


</article>


        </div>
        
    




    



    </body>
</html>
